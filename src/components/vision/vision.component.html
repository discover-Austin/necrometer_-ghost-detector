<div id="vision-camera-container" class="relative w-full h-full bg-black overflow-hidden">

  <!-- Ambient Instability Layers (Always On) -->
  <div class="absolute inset-0 z-10 pointer-events-none"
    [style.filter]="'brightness(' + (1 + brightnessFluctuation()) + ')'">
  </div>

  <!-- Digital Noise Overlay -->
  <div class="absolute inset-0 z-10 pointer-events-none mix-blend-overlay"
    [style.opacity]="noiseOpacity()"
    style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIj48ZmlsdGVyIGlkPSJhIj48ZmVUdXJidWxlbmNlIGJhc2VGcmVxdWVuY3k9Ii43NSIgc3RpdGNoVGlsZXM9InN0aXRjaCIgdHlwZT0iZnJhY3RhbE5vaXNlIi8+PGZlQ29sb3JNYXRyaXggdHlwZT0ic2F0dXJhdGUiIHZhbHVlcz0iMCIvPjwvZmlsdGVyPjxwYXRoIGQ9Ik0wIDBoMzAwdjMwMEgweiIgZmlsdGVyPSJ1cmwoI2EpIiBvcGFjaXR5PSIuNSIvPjwvc3ZnPg==');">
  </div>

  <!-- Chromatic Aberration (at edges) -->
  <div class="absolute inset-0 z-10 pointer-events-none"
    [style.filter]="'blur(' + chromaticAberration() + 'px)'"
    style="background: radial-gradient(circle at center, transparent 60%, rgba(255,0,0,0.05) 100%);">
  </div>

  <!-- Visual Anomaly Manifestation -->
  @if (currentAnomaly()) {
    @let anomaly = currentAnomaly()!;
    <div class="absolute z-20 pointer-events-none anomaly-container"
      [style.left.%]="anomaly.position.x"
      [style.top.%]="anomaly.position.y"
      [class.anomaly-fade-in]="true">
      
      @switch (anomaly.type) {
        @case ('blur') {
          <div class="anomaly-blur"></div>
        }
        @case ('shadow') {
          <div class="anomaly-shadow"></div>
        }
        @case ('distortion') {
          <div class="anomaly-distortion"></div>
        }
        @case ('edge-artifact') {
          <div class="anomaly-edge-artifact"></div>
        }
      }
    </div>
  }

  <!-- Minimal HUD -->
  <div class="absolute inset-0 z-30 pointer-events-none p-4 flex flex-col justify-between">
    <!-- Top corner indicators (pulse on acknowledgment) -->
    <div class="flex justify-between items-start">
      <div class="text-xs text-spectral-500/40 font-mono relative">
        <span class="tracking-wider">MONITORING</span>
        @if (showAcknowledgment()) {
          <div class="absolute -top-2 -left-2 w-2 h-2 bg-spectral-400 rounded-full animate-ping"></div>
          <div class="absolute -top-2 -left-2 w-2 h-2 bg-spectral-400 rounded-full"></div>
        }
      </div>
      <div class="text-xs text-spectral-500/40 font-mono text-right relative">
        <span>{{ deviceState.emfReading() | number:'1.0-0' }} ÂµT</span>
        @if (showAcknowledgment()) {
          <div class="absolute -top-2 -right-2 w-2 h-2 bg-spectral-400 rounded-full animate-ping"></div>
          <div class="absolute -top-2 -right-2 w-2 h-2 bg-spectral-400 rounded-full"></div>
        }
      </div>
    </div>

    <!-- Bottom status bar -->
    <div class="flex justify-center items-end">
      @if (showAcknowledgment()) {
        <div class="text-xs text-spectral-400 font-mono bg-obsidian-950/80 px-3 py-1.5 border border-spectral-500/30 acknowledgment-pulse">
          {{ acknowledgmentText() }}
        </div>
      }
    </div>
  </div>

  <!-- Camera Permission Error Overlay -->
  @if (cameraPermissionError()) {
  <div class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/90 p-8 text-center">
    <svg class="w-16 h-16 text-red-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
      stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
    </svg>
    <h2 class="text-2xl font-bold text-red-400 mb-2">Camera Access Required</h2>
    <p class="text-gray-300 mb-6">{{ cameraPermissionError() }}</p>
    <button (click)="startCamera()"
      class="px-6 py-3 bg-spectral-700 hover:bg-spectral-600 text-white font-bold rounded-lg transition-colors border border-spectral-500/50">
      RETRY
    </button>
  </div>
  }
  
  @if (cameraStatusMessage()) {
  <div class="absolute inset-0 z-40 flex items-center justify-center bg-black/70 text-spectral-200 text-sm font-mono">
    {{ cameraStatusMessage() }}
  </div>
  }
</div>
