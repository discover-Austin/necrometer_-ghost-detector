<div id="vision-camera-container" class="relative w-full h-full bg-black overflow-hidden font-mono text-xs">

  <!-- Night Vision Filter Overlay -->
  <div class="absolute inset-0 z-20 pointer-events-none mix-blend-color-dodge opacity-40 bg-green-900"></div>
  <div class="absolute inset-0 z-20 pointer-events-none opacity-20"
    style="background: repeating-linear-gradient(0deg, transparent 0px, transparent 2px, #0f0 3px);"></div>
  <div class="absolute inset-0 z-20 pointer-events-none text-green-500/10 animate-pulse-slow"
    style="background: radial-gradient(circle at center, transparent 30%, #002200 100%);"></div>

  <!-- HUD Layer -->
  <div class="absolute inset-0 z-30 pointer-events-none p-4 flex flex-col justify-between">

    <!-- Top HUD -->
    <div class="flex justify-between items-start">
      <div class="flex flex-col gap-1 text-green-500/80">
        <span class="tracking-[0.2em]">REC • [LIVE]</span>
        <span>ISO: 3200</span>
        <span>EXP: +1.2</span>
      </div>
      <div class="flex flex-col items-end gap-1 text-green-500/80">
        <span class="text-xl font-bold">{{ deviceState.emfReading() | number:'1.1-1' }} µT</span>
        <span>LAT: 33.1204 N</span>
        <span>LON: 114.2301 W</span>
      </div>
    </div>

    <!-- Center Crosshair -->
    <div class="absolute inset-0 flex items-center justify-center opacity-40">
      <svg width="200" height="200" viewBox="0 0 100 100" fill="none" stroke="#22c55e" stroke-width="0.5">
        <line x1="10" y1="50" x2="40" y2="50" />
        <line x1="60" y1="50" x2="90" y2="50" />
        <line x1="50" y1="10" x2="50" y2="40" />
        <line x1="50" y1="60" x2="50" y2="90" />
        <circle cx="50" cy="50" r="2" fill="#22c55e" />
        <circle cx="50" cy="50" r="30" stroke-dasharray="5 5" />
      </svg>
    </div>

    <!-- Bottom HUD -->
    <div class="flex justify-between items-end">
      <!-- Corner Markers -->
      <svg class="absolute bottom-4 left-4 w-12 h-12 text-green-500/50" viewBox="0 0 50 50" fill="none"
        stroke="currentColor">
        <path d="M0 0 V50 H50" stroke-width="2" />
      </svg>
      <svg class="absolute bottom-4 right-4 w-12 h-12 text-green-500/50" viewBox="0 0 50 50" fill="none"
        stroke="currentColor">
        <path d="M50 0 V50 H0" stroke-width="2" />
      </svg>

      <div class="w-full text-center text-green-500/60 pb-2">
        <span>TARGETING SYSTEM ACTIVE</span>
      </div>
    </div>
  </div>

  <!-- Camera Permission Error Overlay -->
  @if (cameraPermissionError()) {
  <div class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/90 p-8 text-center">
    <svg class="w-16 h-16 text-red-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
      stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
    </svg>
    <h2 class="text-2xl font-bold text-red-400 mb-2">Camera Access Required</h2>
    <p class="text-gray-300 mb-6">{{ cameraPermissionError() }}</p>
    <button (click)="startCamera()"
      class="px-6 py-3 bg-green-700 hover:bg-green-600 text-white font-bold rounded-lg transition-colors border border-green-500/50">
      RETRY LINK
    </button>
  </div>
  }
  @if (cameraStatusMessage()) {
  <div class="absolute inset-0 z-40 flex items-center justify-center bg-black/70 text-green-200 text-sm font-mono">
    {{ cameraStatusMessage() }}
  </div>
  }

  <!-- AR Overlay -->
  <div class="absolute inset-0 z-10 pointer-events-none">
    <!-- Scan button and status -->
    <div class="absolute top-16 right-4 z-40 flex flex-col items-end gap-2 pointer-events-auto">
      <button (click)="scanEnvironment()" [disabled]="isScanningEnvironment()"
        class="px-4 py-2 bg-green-900/50 hover:bg-green-800/60 text-green-300 border border-green-500/50 backdrop-blur-sm rounded font-mono transition-all disabled:opacity-50 flex items-center gap-2 group">
        <span class="group-hover:animate-pulse">
          @if (isScanningEnvironment()) {
          SCANNING...
          } @else {
          SCAN [{{ scanCost }} NC]
          }
        </span>
      </button>
      @if (scanError()) {
      <p class="text-[10px] bg-red-900/80 text-red-200 px-2 py-1 border border-red-500/50">{{ scanError() }}</p>
      }
    </div>

    <!-- AR Entities -->
    @for (entity of arEntities(); track entity.id) {
    <div class="ar-entity" [style.left.%]="entity.x" [style.top.%]="entity.y" [class.contained]="entity.contained"
      [class.targeted]="targetedEntity()?.id === entity.id">
      <div class="ghost-figure">
        <div class="ghost-head"></div>
        <div class="ghost-body"></div>
        <div class="ghost-tail"></div>
      </div>
      @if (targetedEntity()?.id === entity.id) {
      <div class="targeting-reticle">
        <svg viewBox="0 0 100 100">
          <circle class="reticle-circle" cx="50" cy="50" r="45" stroke="#ef4444" />
          <rect x="48" y="0" width="4" height="15" fill="#ef4444" />
          <rect x="48" y="85" width="4" height="15" fill="#ef4444" />
          <rect x="0" y="48" width="15" height="4" fill="#ef4444" />
          <rect x="85" y="48" width="15" height="4" fill="#ef4444" />
        </svg>
        <div class="text-xs text-red-500 font-mono text-center mt-2 bg-black/50 px-1">
          TYPE: {{ entity.type | uppercase }}<br>
          STR: {{ entity.strength | uppercase }}
        </div>
      </div>
      }
    </div>
    }
  </div>
</div>
