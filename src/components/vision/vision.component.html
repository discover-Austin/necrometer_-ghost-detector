<div #visionRoot class="relative w-full h-full pointer-events-none ar-container">

  <!-- Web camera preview (visible when getUserMedia fallback is active) -->
  <div class="web-preview-container" [class.active]="isWebPreviewActive()">
    <video #webPreview class="web-preview-video" autoplay playsinline muted></video>
    <div class="web-preview-label">Camera Preview</div>
  </div>

  <!-- Active Scanline Effect -->
  <div class="scanline"></div>

  <!-- Environmental Scan Overlay -->
  <svg class="scene-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
    @for (object of sceneObjects(); track object.name) {
      @for (polyline of object.polylines; track $index) {
        <polyline 
          [attr.points]="pointsToString(polyline)"
          class="scene-polyline" 
        />
      }
    }
  </svg>

  <!-- Entity Glyphs -->
  @for(entity of arEntities(); track entity.id) {
    <div 
      class="entity-glyph-container"
      [class.targeted]="entity.id === targetedEntity()?.id"
      [class.contained]="entity.contained"
      [class.critical-glitch]="distortionLevel() >= 9"
      [class.interacting]="entity.isInteracting"
      [class.occluded]="entity.occluded"
      [style.--distortion-level]="distortionLevel()"
      [style.left.%]="entity.x"
      [style.top.%]="entity.y"
  [style.transform]="'translate(-50%, -50%) scale(' + (entity.scale || 1) + ') rotate(' + (entity.rotation || 0) + 'deg)'"
  [style.--bob-offset]="(Math.sin(entity.bobPhase || 0) * 4) + 'px'">

        <!-- Soft shadow to ground the figure -->
        <div class="entity-shadow" [style.opacity]="entity.occluded ? 0.15 : 0.6" [style.transform]="'translateY(' + ((entity.scale || 1) * 2) + 'px) scale(' + (entity.scale || 1) + ')' "></div>

        <!-- Humanoid SVG for more lifelike visuals -->
        <svg class="entity-humanoid" viewBox="0 0 100 200" preserveAspectRatio="xMidYMid meet" aria-label="Entity glyph">
          <!-- torso -->
          <ellipse cx="50" cy="110" rx="14" ry="28" fill="rgba(255,255,255,0.9)" opacity="0.95" />
          <!-- head -->
          <circle cx="50" cy="68" r="12" fill="rgba(240,240,240,0.98)" />
          <!-- eyes: use ellipse whose ry depends on blink -->
          <ellipse [attr.cx]="46" [attr.cy]="66" [attr.rx]="1.6" [attr.ry]="1.6 - (entity.blink || 0) * 1.4" fill="#222" />
          <ellipse [attr.cx]="54" [attr.cy]="66" [attr.rx]="1.6" [attr.ry]="1.6 - (entity.blink || 0) * 1.4" fill="#222" />
          <!-- mouth: path whose curve height depends on mouthOpen -->
          <path [attr.d]="'M44 73 Q50 ' + (76 + (entity.mouthOpen || 0) * 8) + ' 56 73'" stroke="#222" stroke-width="0.8" fill="none" stroke-linecap="round" opacity="0.7" />
          <!-- left arm (root at 36,98) -->
          <g transform="translate(36 98) rotate({{ entity.leftArmAngle || 0 }})">
            <path d="M0 0 Q-6 12 -2 28" stroke="rgba(255,255,255,0.95)" stroke-width="4" stroke-linecap="round" fill="none" />
          </g>
          <!-- right arm (root at 64,98) -->
          <g transform="translate(64 98) rotate({{ entity.rightArmAngle || 0 }})">
            <path d="M0 0 Q6 12 2 28" stroke="rgba(255,255,255,0.95)" stroke-width="4" stroke-linecap="round" fill="none" />
          </g>
          <!-- left leg (root at 44,138) -->
          <g transform="translate(44 138) rotate({{ entity.leftLegAngle || 0 }})">
            <path d="M0 0 Q2 22 4 34" stroke="rgba(255,255,255,0.95)" stroke-width="4" stroke-linecap="round" fill="none" />
          </g>
          <!-- right leg (root at 56,138) -->
          <g transform="translate(56 138) rotate({{ entity.rightLegAngle || 0 }})">
            <path d="M0 0 Q-2 22 -4 34" stroke="rgba(255,255,255,0.95)" stroke-width="4" stroke-linecap="round" fill="none" />
          </g>
          <!-- subtle glyph overlay faded to give arcane hint -->
          <image [attr.href]="'data:image/png;base64,' + entity.glyphB64" x="6" y="34" width="88" height="132" opacity="0.12" preserveAspectRatio="xMidYMid slice" />
        </svg>

        @if(entity.contained) {
            <div class="containment-field"></div>
        }
    </div>
  }

  <!-- Targeting Crosshair and HUD -->
  <div class="crosshair-hud">
    @if (targetedEntity(); as entity) {
        <!-- Lock-on state -->
        <svg class="crosshair-lock" viewBox="0 0 100 100">
            <path d="M 30 10 L 10 10 L 10 30" />
            <path d="M 70 10 L 90 10 L 90 30" />
            <path d="M 30 90 L 10 90 L 10 70" />
            <path d="M 70 90 L 90 90 L 90 70" />
        </svg>
        <div class="target-info">
            <p class="target-name">{{ entity.name }}</p>
            <div class="target-instability">
                <p>INSTABILITY</p>
                <div class="instability-bar">
                    <div class="instability-fill" [style.width.%]="entity.instability"></div>
                </div>
            </div>
        </div>
    } @else {
        <!-- Default state -->
        <svg class="crosshair-default" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="4" />
            <path d="M 50 20 L 50 35" />
            <path d="M 50 80 L 50 65" />
            <path d="M 20 50 L 35 50" />
            <path d="M 80 50 L 65 50" />
        </svg>
    }
  </div>

  <!-- Environment Scan Controls -->
  <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-10 pointer-events-auto w-64 text-center">
    <!-- Preview toggle -->
    <div class="mb-2 flex items-center justify-center gap-2 pointer-events-auto">
      <label class="flex items-center gap-2 text-sm text-white">
        <input type="checkbox" [checked]="previewEnabled()" (change)="togglePreview()" />
        Show Camera Preview
      </label>
    </div>
    <!-- Permission denied banner -->
    @if (cameraPermissionDenied()) {
      <div class="scan-error-toast mb-2">
        Camera permission denied. <button (click)="retryPreview()" class="underline">Retry</button>
      </div>
    }
    @if (scanError()) {
      <div class="scan-error-toast mb-2">
        {{ scanError() }}
      </div>
    }
    <button (click)="scanEnvironment()" [disabled]="isScanningEnvironment()" class="scan-button">
      @if (isScanningEnvironment()) {
        <span class="animate-pulse">Scanning Environment...</span>
      } @else {
        <div class="flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm11 2H6v6h8V7z" clip-rule="evenodd" /><path d="M11 3a1 1 0 10-2 0v1h2V3z" /></svg>
          <span>Scan Environment ({{ scanCost }} NC)</span>
        </div>
      }
    </button>
  </div>

</div>

<!-- Permission modal -->
@if (cameraPermissionDenied()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="modal-backdrop"></div>
    <div class="modal-card">
      <h3 class="modal-title">Camera access required</h3>
      <p class="modal-body">This feature requires camera access to scan the environment. Please enable camera permission in your browser or device settings.</p>
      <div class="modal-actions">
        <button (click)="retryPreview()" class="scan-button">Retry</button>
        <button (click)="cameraPermissionDenied.set(false)" class="scan-button">Close</button>
      </div>
    </div>
  </div>
}