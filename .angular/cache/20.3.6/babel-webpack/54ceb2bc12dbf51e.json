{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/grand/necrometer_-ghost-detector-1/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { inject, signal, effect } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { DeviceStateService } from '../../services/device-state.service';\nimport { SensorService } from '../../services/sensor.service';\nimport { UpgradeService } from '../../services/upgrade.service';\nimport { GeminiService } from '../../services/gemini.service';\nimport { CameraPreview } from '@capacitor-community/camera-preview';\nimport { App } from '@capacitor/app';\nimport { AudioService } from '../../services/audio.service';\nimport * as i0 from \"@angular/core\";\nconst _forTrack0 = ($index, $item) => $item.id;\nfunction VisionComponent_Conditional_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵdomElementStart(0, \"div\", 1);\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵdomElementStart(1, \"svg\", 10);\n    i0.ɵɵdomElement(2, \"path\", 11);\n    i0.ɵɵdomElementEnd();\n    i0.ɵɵnamespaceHTML();\n    i0.ɵɵdomElementStart(3, \"h2\", 12);\n    i0.ɵɵtext(4, \"Camera Access Required\");\n    i0.ɵɵdomElementEnd();\n    i0.ɵɵdomElementStart(5, \"p\", 13);\n    i0.ɵɵtext(6);\n    i0.ɵɵdomElementEnd();\n    i0.ɵɵdomElementStart(7, \"button\", 14);\n    i0.ɵɵdomListener(\"click\", function VisionComponent_Conditional_1_Template_button_click_7_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.startCamera());\n    });\n    i0.ɵɵtext(8, \" Retry \");\n    i0.ɵɵdomElementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(6);\n    i0.ɵɵtextInterpolate(ctx_r1.cameraPermissionError());\n  }\n}\nfunction VisionComponent_Conditional_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵdomElementStart(0, \"span\", 7);\n    i0.ɵɵtext(1, \"Scanning...\");\n    i0.ɵɵdomElementEnd();\n  }\n}\nfunction VisionComponent_Conditional_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵdomElementStart(0, \"span\");\n    i0.ɵɵtext(1);\n    i0.ɵɵdomElementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate1(\"Scan (\", ctx_r1.scanCost, \" NC)\");\n  }\n}\nfunction VisionComponent_Conditional_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵdomElementStart(0, \"p\", 8);\n    i0.ɵɵtext(1);\n    i0.ɵɵdomElementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵtextInterpolate(ctx_r1.scanError());\n  }\n}\nfunction VisionComponent_For_11_Conditional_5_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵdomElementStart(0, \"div\", 20);\n    i0.ɵɵnamespaceSVG();\n    i0.ɵɵdomElementStart(1, \"svg\", 21);\n    i0.ɵɵdomElement(2, \"circle\", 22);\n    i0.ɵɵdomElementEnd()();\n  }\n}\nfunction VisionComponent_For_11_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵdomElementStart(0, \"div\", 15)(1, \"div\", 16);\n    i0.ɵɵdomElement(2, \"div\", 17)(3, \"div\", 18)(4, \"div\", 19);\n    i0.ɵɵdomElementEnd();\n    i0.ɵɵconditionalCreate(5, VisionComponent_For_11_Conditional_5_Template, 3, 0, \"div\", 20);\n    i0.ɵɵdomElementEnd();\n  }\n  if (rf & 2) {\n    let tmp_13_0;\n    let tmp_14_0;\n    const entity_r3 = ctx.$implicit;\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵstyleProp(\"left\", entity_r3.x, \"%\")(\"top\", entity_r3.y, \"%\");\n    i0.ɵɵclassProp(\"contained\", entity_r3.contained)(\"targeted\", ((tmp_13_0 = ctx_r1.targetedEntity()) == null ? null : tmp_13_0.id) === entity_r3.id);\n    i0.ɵɵadvance(5);\n    i0.ɵɵconditional(((tmp_14_0 = ctx_r1.targetedEntity()) == null ? null : tmp_14_0.id) === entity_r3.id ? 5 : -1);\n  }\n}\nexport let VisionComponent = /*#__PURE__*/(() => {\n  var _staticBlock;\n  class VisionComponent {\n    constructor() {\n      this.deviceState = inject(DeviceStateService);\n      this.sensorService = inject(SensorService);\n      this.upgradeService = inject(UpgradeService);\n      this.geminiService = inject(GeminiService);\n      this.audioService = inject(AudioService);\n      this.arEntities = signal([], ...(ngDevMode ? [{\n        debugName: \"arEntities\"\n      }] : []));\n      this.targetedEntity = signal(null, ...(ngDevMode ? [{\n        debugName: \"targetedEntity\"\n      }] : []));\n      this.currentTime = signal(Date.now(), ...(ngDevMode ? [{\n        debugName: \"currentTime\"\n      }] : []));\n      this.isCameraActive = false;\n      this.cameraPermissionError = signal(null, ...(ngDevMode ? [{\n        debugName: \"cameraPermissionError\"\n      }] : []));\n      this.appStateListener = null;\n      this.isScanningEnvironment = signal(false, ...(ngDevMode ? [{\n        debugName: \"isScanningEnvironment\"\n      }] : []));\n      this.scanError = signal(null, ...(ngDevMode ? [{\n        debugName: \"scanError\"\n      }] : []));\n      this.sceneObjects = signal([], ...(ngDevMode ? [{\n        debugName: \"sceneObjects\"\n      }] : []));\n      this.scanCost = 5;\n      this.animationFrameId = null;\n      this.physics = {\n        gravityTilt: 0.00005,\n        downwardDrift: 0.00002,\n        friction: 0.97,\n        emfAgitation: 0.00015,\n        maxSpeed: 0.2,\n        sceneRepulsion: 0.0001,\n        sceneRepulsionRadius: 12\n      };\n      effect(() => {\n        this.currentTime();\n      });\n    }\n    ngOnInit() {\n      this.startCamera();\n      this.startAnimationLoop();\n      this.appStateListener = App.addListener('appStateChange', ({\n        isActive\n      }) => {\n        if (isActive && this.cameraPermissionError() && !this.isCameraActive) {\n          this.startCamera();\n        }\n      });\n    }\n    ngOnDestroy() {\n      this.stopCamera();\n      this.stopAnimationLoop();\n      if (this.appStateListener) {\n        this.appStateListener.remove();\n      }\n    }\n    ngOnChanges(changes) {\n      if (changes['detections']) {\n        this.syncDetectionsToAREntities();\n      }\n    }\n    startCamera() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        if (_this.isCameraActive) return;\n        try {\n          yield CameraPreview.start({\n            position: 'rear',\n            toBack: true,\n            parent: 'vision-camera-container'\n          });\n          _this.isCameraActive = true;\n          _this.cameraPermissionError.set(null);\n        } catch (e) {\n          _this.handleCameraError(e);\n        }\n      })();\n    }\n    stopCamera() {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        if (!_this2.isCameraActive) return;\n        _this2.isCameraActive = false;\n        try {\n          yield CameraPreview.stop();\n        } catch (e) {\n          console.warn(\"Could not stop camera preview\", e);\n        }\n      })();\n    }\n    handleCameraError(err) {\n      const errorMessage = err instanceof Error ? err.message : String(err);\n      if (errorMessage.toLowerCase().includes('permission')) {\n        this.cameraPermissionError.set(\"Camera permission denied. Please enable camera access in your device settings.\");\n      } else {\n        this.cameraPermissionError.set(\"Failed to start the camera. Please ensure permissions are granted and try again.\");\n      }\n    }\n    scanEnvironment() {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        if (_this3.isScanningEnvironment() || !_this3.isCameraActive) return;\n        if (!_this3.upgradeService.spendCredits(_this3.scanCost)) {\n          _this3.scanError.set(`Insufficient Credits. Requires ${_this3.scanCost} NC.`);\n          setTimeout(() => _this3.scanError.set(null), 4000);\n          return;\n        }\n        _this3.isScanningEnvironment.set(true);\n        _this3.scanError.set(null);\n        _this3.sceneObjects.set([]);\n        try {\n          const result = yield CameraPreview.capture({\n            quality: 85\n          });\n          const base64Image = result.value;\n          const analysisResult = yield _this3.geminiService.analyzeScene(base64Image);\n          _this3.sceneObjects.set(analysisResult.objects);\n          setTimeout(() => _this3.sceneObjects.set([]), 15000);\n        } catch (err) {\n          console.error('Environment scan failed:', err);\n          _this3.scanError.set('Scene analysis failed. Connection unstable.');\n          _this3.upgradeService.addCredits(_this3.scanCost); // Refund on failure\n          setTimeout(() => _this3.scanError.set(null), 4000);\n        } finally {\n          _this3.isScanningEnvironment.set(false);\n        }\n      })();\n    }\n    syncDetectionsToAREntities() {\n      this.arEntities.update(currentEntities => {\n        const detectionMap = new Map(this.detections.map(d => [d.id, d]));\n        const newEntities = this.detections.filter(d => !currentEntities.some(e => e.id === d.id)).map(d => this.createAREntity(d));\n        return [...currentEntities.filter(e => detectionMap.has(e.id)), ...newEntities];\n      });\n    }\n    createAREntity(detection) {\n      return {\n        ...detection,\n        x: Math.random() * 90 + 5,\n        y: Math.random() * 90 + 5,\n        vx: (Math.random() - 0.5) * 0.05,\n        vy: (Math.random() - 0.5) * 0.05,\n        ax: 0,\n        ay: 0\n      };\n    }\n    startAnimationLoop() {\n      const animate = () => {\n        this.updateAREntities();\n        this.animationFrameId = requestAnimationFrame(animate);\n      };\n      animate();\n    }\n    stopAnimationLoop() {\n      if (this.animationFrameId) {\n        cancelAnimationFrame(this.animationFrameId);\n      }\n    }\n    updateAREntities() {\n      const orientation = this.sensorService.orientation();\n      const gravityX = orientation ? orientation.gamma / 90 : 0;\n      const gravityY = orientation ? Math.max(-90, Math.min(90, orientation.beta)) / 90 : 0;\n      this.arEntities.update(entities => {\n        let closestEntity = null;\n        let minDistance = 15;\n        const updatedEntities = entities.map(e => {\n          let {\n            x,\n            y,\n            vx,\n            vy,\n            ax,\n            ay\n          } = e;\n          if (e.contained) {\n            vx *= 0.9;\n            vy *= 0.9;\n            x += vx;\n            y += vy;\n            return {\n              ...e,\n              x,\n              y,\n              vx,\n              vy\n            };\n          }\n          ax = gravityX * this.physics.gravityTilt;\n          ay = gravityY * this.physics.gravityTilt + this.physics.downwardDrift;\n          const agitation = this.deviceState.emfReading() * this.physics.emfAgitation;\n          ax += (Math.random() - 0.5) * agitation;\n          ay += (Math.random() - 0.5) * agitation;\n          vx += ax;\n          vy += ay;\n          vx *= this.physics.friction;\n          vy *= this.physics.friction;\n          const speed = Math.sqrt(vx * vx + vy * vy);\n          if (speed > this.physics.maxSpeed) {\n            vx = vx / speed * this.physics.maxSpeed;\n            vy = vy / speed * this.physics.maxSpeed;\n          }\n          x += vx;\n          y += vy;\n          if (y > 105 || x < -5 || x > 105) {\n            x = Math.random() * 80 + 10;\n            y = -5;\n            vx = (Math.random() - 0.5) * 0.02;\n            vy = Math.random() * 0.05;\n          }\n          const updatedEntity = {\n            ...e,\n            x,\n            y,\n            vx,\n            vy,\n            ax,\n            ay\n          };\n          const distanceToCenter = Math.sqrt(Math.pow(updatedEntity.x - 50, 2) + Math.pow(updatedEntity.y - 45, 2));\n          if (distanceToCenter < minDistance) {\n            minDistance = distanceToCenter;\n            closestEntity = updatedEntity;\n          }\n          return updatedEntity;\n        });\n        this.targetedEntity.set(closestEntity);\n        return updatedEntities;\n      });\n    }\n    static #_ = _staticBlock = () => (this.ɵfac = function VisionComponent_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || VisionComponent)();\n    }, this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: VisionComponent,\n      selectors: [[\"app-vision\"]],\n      inputs: {\n        detections: \"detections\"\n      },\n      features: [i0.ɵɵNgOnChangesFeature],\n      decls: 12,\n      vars: 4,\n      consts: [[\"id\", \"vision-camera-container\", 1, \"relative\", \"w-full\", \"h-full\", \"bg-transparent\"], [1, \"absolute\", \"inset-0\", \"z-50\", \"flex\", \"flex-col\", \"items-center\", \"justify-center\", \"bg-black/90\", \"p-8\", \"text-center\"], [1, \"absolute\", \"inset-0\", \"z-10\", \"pointer-events-none\"], [1, \"absolute\", \"top-2\", \"right-2\", \"z-30\", \"flex\", \"flex-col\", \"items-end\", \"gap-2\", \"pointer-events-auto\"], [1, \"px-4\", \"py-2\", \"bg-[var(--color-primary-700)]\", \"hover:bg-[var(--color-primary-600)]\", \"text-white\", \"font-bold\", \"rounded-lg\", \"transition-colors\", \"disabled:bg-gray-600\", \"disabled:cursor-not-allowed\", \"flex\", \"items-center\", \"gap-2\", 3, \"click\", \"disabled\"], [\"xmlns\", \"http://www.w3.org/2000/svg\", \"viewBox\", \"0 0 20 20\", \"fill\", \"currentColor\", 1, \"w-5\", \"h-5\"], [\"fill-rule\", \"evenodd\", \"d\", \"M6.22 8.22a.75.75 0 011.06 0l3.22 3.22a.75.75 0 01-1.06 1.06L8 9.81V14.5a.75.75 0 01-1.5 0V9.81L4.47 11.53a.75.75 0 01-1.06-1.06l3.22-3.22zm9.28-3.22a.75.75 0 01-1.06 0L11.22 1.78a.75.75 0 011.06-1.06l2.22 2.22V1a.75.75 0 011.5 0v3.69l2.22-2.22a.75.75 0 011.06 1.06l-3.22 3.22zM2.97 14.47a.75.75 0 010-1.06l3.22-3.22a.75.75 0 011.06 1.06L5.53 13H10a.75.75 0 010 1.5H5.53l1.72 1.72a.75.75 0 01-1.06 1.06l-3.22-3.22zm12.28 3.22a.75.75 0 01-1.06 0l-3.22-3.22a.75.75 0 011.06-1.06l1.72 1.72V15a.75.75 0 011.5 0v3.69l1.72-1.72a.75.75 0 011.06 1.06l-3.22 3.22z\", \"clip-rule\", \"evenodd\"], [1, \"animate-pulse\"], [1, \"text-xs\", \"bg-red-800/80\", \"text-red-200\", \"px-3\", \"py-1\", \"rounded-md\"], [1, \"ar-entity\", 3, \"left\", \"top\", \"contained\", \"targeted\"], [\"xmlns\", \"http://www.w3.org/2000/svg\", \"fill\", \"none\", \"viewBox\", \"0 0 24 24\", \"stroke-width\", \"1.5\", \"stroke\", \"currentColor\", 1, \"w-16\", \"h-16\", \"text-red-500\", \"mb-4\"], [\"stroke-linecap\", \"round\", \"stroke-linejoin\", \"round\", \"d\", \"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z\"], [1, \"text-2xl\", \"font-bold\", \"text-red-400\", \"mb-2\"], [1, \"text-gray-300\", \"mb-6\"], [1, \"px-6\", \"py-3\", \"bg-[var(--color-primary-600)]\", \"hover:bg-[var(--color-primary-500)]\", \"text-white\", \"font-bold\", \"rounded-lg\", \"transition-colors\", 3, \"click\"], [1, \"ar-entity\"], [1, \"ghost-figure\"], [1, \"ghost-head\"], [1, \"ghost-body\"], [1, \"ghost-tail\"], [1, \"targeting-reticle\"], [\"viewBox\", \"0 0 100 100\"], [\"cx\", \"50\", \"cy\", \"50\", \"r\", \"45\", 1, \"reticle-circle\"]],\n      template: function VisionComponent_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵdomElementStart(0, \"div\", 0);\n          i0.ɵɵconditionalCreate(1, VisionComponent_Conditional_1_Template, 9, 1, \"div\", 1);\n          i0.ɵɵdomElementStart(2, \"div\", 2)(3, \"div\", 3)(4, \"button\", 4);\n          i0.ɵɵdomListener(\"click\", function VisionComponent_Template_button_click_4_listener() {\n            return ctx.scanEnvironment();\n          });\n          i0.ɵɵnamespaceSVG();\n          i0.ɵɵdomElementStart(5, \"svg\", 5);\n          i0.ɵɵdomElement(6, \"path\", 6);\n          i0.ɵɵdomElementEnd();\n          i0.ɵɵconditionalCreate(7, VisionComponent_Conditional_7_Template, 2, 0, \"span\", 7)(8, VisionComponent_Conditional_8_Template, 2, 1, \"span\");\n          i0.ɵɵdomElementEnd();\n          i0.ɵɵconditionalCreate(9, VisionComponent_Conditional_9_Template, 2, 1, \"p\", 8);\n          i0.ɵɵdomElementEnd();\n          i0.ɵɵrepeaterCreate(10, VisionComponent_For_11_Template, 6, 9, \"div\", 9, _forTrack0);\n          i0.ɵɵdomElementEnd()();\n        }\n        if (rf & 2) {\n          i0.ɵɵadvance();\n          i0.ɵɵconditional(ctx.cameraPermissionError() ? 1 : -1);\n          i0.ɵɵadvance(3);\n          i0.ɵɵdomProperty(\"disabled\", ctx.isScanningEnvironment());\n          i0.ɵɵadvance(3);\n          i0.ɵɵconditional(ctx.isScanningEnvironment() ? 7 : 8);\n          i0.ɵɵadvance(2);\n          i0.ɵɵconditional(ctx.scanError() ? 9 : -1);\n          i0.ɵɵadvance();\n          i0.ɵɵrepeater(ctx.arEntities());\n        }\n      },\n      dependencies: [CommonModule],\n      styles: [\".ar-entity[_ngcontent-%COMP%]{position:absolute;width:60px;height:80px;will-change:transform,opacity;transition:opacity .5s}.ghost-figure[_ngcontent-%COMP%]{width:100%;height:100%;filter:drop-shadow(0 0 10px rgba(13,227,255,.7)) blur(1.5px);animation:_ngcontent-%COMP%_float 6s ease-in-out infinite;transform-origin:bottom center}.ar-entity.targeted[_ngcontent-%COMP%]   .ghost-figure[_ngcontent-%COMP%]{filter:drop-shadow(0 0 15px rgb(255,17,0)) blur(1px)}.ghost-head[_ngcontent-%COMP%]{width:60%;height:45%;background:radial-gradient(circle,#fffc,#c8f0ff80 70%);border-radius:50% 50% 40% 40%/60% 60% 40% 40%;position:relative;left:20%}.ghost-body[_ngcontent-%COMP%]{width:100%;height:55%;background:linear-gradient(to bottom,#c8f0ff80,#96dcff33);border-radius:40% 40% 0 0;position:absolute;top:30%}.ghost-tail[_ngcontent-%COMP%]{position:absolute;bottom:-10px;left:0;width:100%;height:20px;background:#96dcff33;border-radius:0 0 50% 50%;filter:blur(3px);animation:_ngcontent-%COMP%_tail-sway 3s ease-in-out infinite}@keyframes _ngcontent-%COMP%_float{0%,to{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-15px) rotate(2deg)}}@keyframes _ngcontent-%COMP%_tail-sway{0%,to{transform:translate(-5px) scaleX(.9)}50%{transform:translate(5px) scaleX(1.1)}}.targeting-reticle[_ngcontent-%COMP%]{position:absolute;top:-20%;left:-20%;width:140%;height:140%;animation:_ngcontent-%COMP%_spin 8s linear infinite}.reticle-circle[_ngcontent-%COMP%]{stroke:#ff0000b3;stroke-width:2;fill:none;stroke-dasharray:10 5;animation:_ngcontent-%COMP%_pulse-reticle 2s infinite ease-in-out}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}@keyframes _ngcontent-%COMP%_pulse-reticle{0%,to{stroke-width:2;opacity:.7}50%{stroke-width:4;opacity:1}}\"],\n      changeDetection: 0\n    }));\n  }\n  _staticBlock();\n  return VisionComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}