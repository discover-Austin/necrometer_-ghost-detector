name: Android Release (Signed AAB)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-signed-aab:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Restore Node (for Angular build)
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm ci

      - name: Build web app
        run: |
          npm run build

      - name: Detect credentials
        # Export secrets to env (safer for multiline content) and set env flags
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -n "$RELEASE_KEYSTORE_BASE64" ]; then
            echo "HAS_KEYSTORE=true" >> $GITHUB_ENV
          else
            echo "HAS_KEYSTORE=false" >> $GITHUB_ENV
          fi
          if [ -n "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" ]; then
            echo "HAS_PLAY_JSON=true" >> $GITHUB_ENV
          else
            echo "HAS_PLAY_JSON=false" >> $GITHUB_ENV
          fi

      - name: Prepare android/keystore
        if: env.HAS_KEYSTORE == 'true'
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          mkdir -p android/keystore
          # Use printf to avoid interpretation of escape sequences, strip CRs, then decode
          printf '%s' "$RELEASE_KEYSTORE_BASE64" | tr -d '\r' | base64 --decode > android/keystore/my-release-key.jks

      - name: Set signing env vars
        if: env.HAS_KEYSTORE == 'true'
        run: |
          echo "RELEASE_KEYSTORE_PATH=android/keystore/my-release-key.jks" >> $GITHUB_ENV
          echo "RELEASE_KEYSTORE_PASSWORD=${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "RELEASE_KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "RELEASE_KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: Make gradlew executable
        run: |
          if [ -f android/gradlew ]; then chmod +x android/gradlew; fi

      - name: Diagnose Gradle Java home
        run: |
          echo "-- gradle.properties lines that mention java.home --" || true
          grep -n "org.gradle.java.home" android/gradle.properties || true
          echo "-- env JAVA_HOME --"
          echo $JAVA_HOME

      - name: Build Android AAB (bundleRelease)
        run: |
          cd android && ./gradlew -Dorg.gradle.java.home="$JAVA_HOME" bundleRelease --no-daemon --warning-mode all

      - name: Upload signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: android/app/build/outputs/bundle/release/app-release.aab

      - name: Prepare Google Play service account
        if: env.HAS_PLAY_JSON == 'true'
        run: |
          echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" > $HOME/gplay-service-account.json

      - name: Publish to Google Play (internal)
        if: env.HAS_PLAY_JSON == 'true'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.ghosted_necrometer.app
          releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
          track: ${{ env.PLAY_TRACK || 'internal' }}

      - name: Create GitHub Release (fallback)
        id: create_release
        if: env.HAS_PLAY_JSON != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name || 'unsigned-release' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload AAB to GitHub Release (fallback)
        if: env.HAS_PLAY_JSON != 'true'
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: android/app/build/outputs/bundle/release/app-release.aab
          asset_name: app-release.aab
          asset_content_type: application/octet-stream
